{"version":3,"sources":["ucsc-medbook:reactive-table/lib/filter.js","ucsc-medbook:reactive-table/lib/server.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA,iD;AACA,mC;AACA,iC;AACA,mB;AACA,sC;;AAEA,sB;AACA,sB;AACA,iC;AACA,kB;AACA,sC;AACA,wE;AACA,wB;AACA,wB;AACA,c;AACA,6C;AACA,O;AACA,6C;AACA,sC;AACA,qD;AACA,c;AACA,uB;AACA,gD;AACA,O;AACA,Y;AACA,yB;AACA,K;AACA,K;AACA,iB;AACA,E;;AAEA,kC;AACA,0D;AACA,E;;AAEA,sD;AACA,4B;AACA,2C;AACA,iC;AACA,G;AACA,wB;AACA,yE;AACA,kD;AACA,0C;AACA,S;AACA,Y;AACA,kD;AACA,uF;AACA,S;AACA,K;AACA,G;AACA,6B;AACA,qB;AACA,e;AACA,4C;AACA,2C;AACA,2C;AACA,6C;AACA,O;AACA,+B;AACA,uC;AACA,uD;AACA,uB;AACA,iD;AACA,oC;;AAEA,4C;AACA,+B;AACA,qE;AACA,4C;AACA,S;AACA,S;AACA,mC;AACA,mD;AACA,oC;AACA,O;AACA,O;AACA,G;AACA,qD;AACA,E;;;;;;;;;;;;;;;;;;;AC/EA,mB;;AAEA,6F;AACA,6G;AACA,qB;AACA,mB;AACA,M;AACA,+C;AACA,qD;AACA,c;AACA,0C;AACA,O;;AAEA,sD;AACA,uE;AACA,kB;AACA,O;;AAEA,6C;AACA,iD;AACA,c;AACA,sC;AACA,O;AACA,sB;AACA,qF;AACA,wC;AACA,yC;AACA,O;AACA,yD;AACA,iC;;AAEA,0C;AACA,yB;AACA,6C;AACA,sC;AACA,gB;AACA,Q;;AAEA,iC;AACA,6C;AACA,Q;AACA,oB;AACA,wC;AACA,4B;AACA,S;;AAEA,oC;AACA,gC;AACA,+C;AACA,qC;AACA,uB;AACA,0C;AACA,iF;AACA,kC;AACA,a;AACA,kB;AACA,6E;AACA,gC;AACA,W;AACA,W;AACA,Q;;AAEA,yE;AACA,mC;AACA,yE;AACA,S;;AAEA,8B;;AAEA,0C;AACA,sC;AACA,8B;AACA,0F;AACA,yB;AACA,W;AACA,U;;AAEA,wC;AACA,wF;AACA,mE;AACA,0B;AACA,uB;AACA,U;;AAEA,wC;AACA,uB;AACA,S;;AAEA,S;AACA,2B;;AAEA,mB;;AAEA,+B;AACA,sB;AACA,S;AACA,O;AACA,E","file":"/packages/ucsc-medbook_reactive-table.js","sourcesContent":["var parseFilterString = function (filterString) {\n  var startQuoteRegExp = /^[\\'\\\"]/;\n  var endQuoteRegExp = /[\\'\\\"]$/;\n  var filters = [];\n  var words = filterString.split(' ');\n\n  var inQuote = false;\n  var quotedWord = '';\n  _.each(words, function (word) {\n    if (inQuote) {\n      if (endQuoteRegExp.test(word)) {\n        filters.push(quotedWord + ' ' + word.slice(0, word.length - 1));\n        inQuote = false;\n        quotedWord = '';\n      } else {\n        quotedWord = quotedWord + ' ' + word;\n      }\n    } else if (startQuoteRegExp.test(word)) {\n      if (endQuoteRegExp.test(word)) {\n        filters.push(word.slice(1, word.length - 1));\n      } else {\n        inQuote = true;\n        quotedWord = word.slice(1, word.length);\n      }\n    } else {\n      filters.push(word);\n    }\n  });\n  return filters;\n};\n\nvar escapeRegex = function(text) {\n  return text.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\");\n};\n\ngetFilterQuery = function (filter, fields, settings) {\n  settings = settings || {};\n  if (settings.enableRegex === undefined) {\n    settings.enableRegex = false;\n  }\n  if (settings.fields) {\n    if (_.any(settings.fields, function (include) { return include; })) {\n      fields = _.filter(fields, function (field) {\n        return settings.fields[field.key];\n      });\n    } else {\n      fields = _.filter(fields, function (field) {\n        return _.isUndefined(settings.fields[field.key]) || settings.fields[field.key];\n      });\n    }\n  }\n  var numberRegExp = /^\\d+$/;\n  var queryList = [];\n  if (filter) {\n    var filters = parseFilterString(filter);\n    _.each(filters, function (filterWord) {\n      if (settings.enableRegex === false) {\n        filterWord = escapeRegex(filterWord);\n      }\n      var filterQueryList = [];\n      _.each(fields, function (field) {\n        var filterRegExp = new RegExp(filterWord, 'i');\n        var query = {};\n        query[field.key || field] = filterRegExp;\n        filterQueryList.push(query);\n\n        if (numberRegExp.test(filterWord)) {\n          var numberQuery = {};\n          numberQuery[field.key || field] = parseInt(filterWord, 10);\n          filterQueryList.push(numberQuery);\n        }\n      });\n      if (filterQueryList.length) {\n        var filterQuery = {'$or': filterQueryList};\n        queryList.push(filterQuery);\n      }\n    });\n  }\n  return queryList.length ? {'$and': queryList} : {};\n};\n","ReactiveTable = {};\n\nReactiveTable.publish = function (name, collectionOrFunction, selectorOrFunction, settings) {\n    Meteor.publish(\"reactive-table-\" + name, function (publicationId, filter, fields, options, rowsPerPage) {\n      var collection;\n      var selector;\n      \n      if (_.isFunction(collectionOrFunction)) {\n        collection = collectionOrFunction.call(this);\n      } else {\n        collection = collectionOrFunction;\n      }\n\n      if (!(collection instanceof Mongo.Collection)) {\n        console.log(\"ReactiveTable.publish: no collection to publish\");\n        return [];\n      }\n\n      if (_.isFunction(selectorOrFunction)) {\n        selector = selectorOrFunction.call(this);\n      } else {\n        selector = selectorOrFunction;\n      }\n      var self = this;\n      var filterQuery = _.extend(getFilterQuery(filter, fields, settings), selector);\n      if (settings && settings.fields) {\n        options.fields = settings.fields;\n      }\n      var cursor = collection.find(filterQuery, options);\n      var count = cursor.count();\n\n      var getRow = function (row, index) {\n        return _.extend({\n          \"reactive-table-id\": publicationId,\n          \"reactive-table-sort\": index\n        }, row);\n      };\n\n      var getRows = function () {\n        return _.map(cursor.fetch(), getRow);\n      };\n      var rows = {};\n      _.each(getRows(), function (row) {\n        rows[row._id] = row;\n      });\n\n      var updateRows = function () {\n        var newRows = getRows();\n        _.each(newRows, function (row, index) {\n          var oldRow = rows[row._id];\n          if (oldRow) {\n            if (!_.isEqual(oldRow, row)) {\n              self.changed(\"reactive-table-rows-\" + publicationId, row._id, row);\n              rows[row._id] = row;\n            }\n          } else {\n            self.added(\"reactive-table-rows-\" + publicationId, row._id, row);\n            rows[row._id] = row;\n          }\n        });\n      };\n\n      self.added(\"reactive-table-counts\", publicationId, {count: count});\n      _.each(rows, function (row) {\n        self.added(\"reactive-table-rows-\" + publicationId, row._id, row);\n      });\n\n      var initializing = true;\n\n      var handle = cursor.observeChanges({\n        added: function (id, fields) {\n          if (!initializing) {\n            self.changed(\"reactive-table-counts\", publicationId, {count: cursor.count()});\n            updateRows();\n          }\n        },\n\n        removed: function (id, fields) {\n          self.changed(\"reactive-table-counts\", publicationId, {count: cursor.count()});\n          self.removed(\"reactive-table-rows-\" + publicationId, id);\n          delete rows[id];\n          updateRows();\n        },\n\n        changed: function (id, fields) {\n          updateRows();\n        }\n\n      });\n      initializing = false;\n\n      self.ready();\n\n      self.onStop(function () {\n        handle.stop();\n      });\n    });\n};\n"]}